version: 8.1.{build}
image: Visual Studio 2019

#skip_commits:
#  files:
#    - PowerEditor/bin/*/*.xml
#    - PowerEditor/installer/*/*.xml

environment:
  matrix:
    - compiler: MSC
      platform: Win32

    - compiler: MSC
      platform: x64

    - compiler: MSC
      platform: arm64

    - compiler: GCC
      platform: i686

    - compiler: GCC
      platform: x86_64

configuration:
    - Release
    - Debug

matrix:
  exclude:
    - compiler: GCC
      configuration: Debug

for:
- matrix:
    only:
      - compiler: MSC
  build:
    parallel: true
    project: PowerEditor\visual.net\notepadPlus.sln

- matrix:
    only:
      - compiler: MSC
        platform: Win32
        configuration: Release
  artifacts:
    - path: PowerEditor\bin\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe

- matrix:
    only:
      - compiler: MSC
        platform: Win32
        configuration: Debug
  artifacts:
    - path: PowerEditor\visual.net\Debug\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe
  after_build:
    #xml files syntax checks
    - set PATH=C:\Python38;C:\Python38\Scripts;%PATH%
    - python -m pip install requests rfc3987 pywin32 lxml
    - python PowerEditor\Test\xmlValidator\validator_xml.py

    - ps: |
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\visual.net\Debug\Notepad++.exe" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\src\langs.model.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\src\stylers.model.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\src\shortcuts.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\src\contextMenu.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\installer\functionList" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin" -Recurse

        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\installer\filesForTesting\regexGlobalTest.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin\functionList"
        Copy-Item "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\installer\filesForTesting\overrideMap.xml" -Destination "$env:APPVEYOR_BUILD_FOLDER\PowerEditor\bin\functionList"

        cd .\PowerEditor\Test\FunctionList\
        .\unitTestLauncher.ps1
        if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode)  }

        cd ..\UrlDetection
        .\verifyUrlDetection.ps1

        cd "$env:APPVEYOR_BUILD_FOLDER"

- matrix:
    only:
      - compiler: MSC
        platform: x64
        configuration: Release
  artifacts:
    - path: PowerEditor\bin64\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe

- matrix:
    only:
      - compiler: MSC
        platform: x64
        configuration: Debug
  artifacts:
    - path: PowerEditor\visual.net\x64\Debug\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe

- matrix:
    only:
      - compiler: MSC
        platform: arm64
        configuration: Release
  artifacts:
    - path: PowerEditor\binarm64\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe

- matrix:
    only:
      - compiler: MSC
        platform: arm64
        configuration: Debug
  artifacts:
    - path: PowerEditor\visual.net\arm64\Debug\Notepad++.exe
      name: Notepad++.$(platform).$(configuration).exe


- matrix:
    only:
      - compiler: GCC
        platform: i686
  install:
    - set PATH=C:\mingw-w64\i686-8.1.0-posix-dwarf-rt_v6-rev0\mingw32\bin;%PATH:C:\Program Files\Git\usr\bin;=%

- matrix:
    only:
      - compiler: GCC
        platform: x86_64
  install:
    - set PATH=C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64\bin;%PATH:C:\Program Files\Git\usr\bin;=%

- matrix:
    only:
      - compiler: GCC
        configuration: Release
  build_script:
    - mingw32-make -f PowerEditor\gcc\makefile
  artifacts:
    - path: bin.$(platform)\notepad++.exe
      name: Notepad++.$(compiler).$(platform).$(configuration).exe
 
before_build:
    - ps: |
        Write-Output "Compiler: $env:compiler"
        Write-Output "platform: $env:platform"
        Write-Output "Configuration: $env:configuration"
